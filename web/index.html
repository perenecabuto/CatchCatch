<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">

<!-- BOOTSTRAP -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css" integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u"
    crossorigin="anonymous">
<link href="https://maxcdn.bootstrapcdn.com/bootswatch/3.3.7/yeti/bootstrap.min.css" rel="stylesheet" integrity="sha384-HzUaiJdCTIY/RL2vDPRGdEQHHahjzwoJJzGUkYjHVzTwXFQ2QN/nVgX7tzoMW3Ov"
    crossorigin="anonymous">

<!-- SOCKETIO -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>

<!-- MAP -->
<link rel="stylesheet" href="https://openlayers.org/en/v4.0.1/css/ol.css" type="text/css">
<script src="https://openlayers.org/en/v4.0.1/build/ol.js"></script>


<script>
    function reset() {
        console.log("admin:clear");
        socket.emit('admin:clear');
    }

    function disconnectPlayer(playerId) {
        console.log("admin:disconnect", playerId);
        socket.emit('admin:disconnect', playerId);
    }

    function requestFeatures() {
        socket.emit("admin:feature:request-list", "checkpoint");
        socket.emit("admin:feature:request-list", "geofences");
    }

    var lastPos = { coords: { latitude: 0, longitude: 0 } };

    function recoverPosition() {
        var hasCachedPosition = lastPos.coords.latitude != 0 && lastPos.coords.longitude != 0;
        if (hasCachedPosition) {
            updatePosition(lastPos);
        }
    }

    function updatePosition(pos) {
        var coords = { x: pos.coords.latitude, y: pos.coords.longitude };
        lastPos = pos;
        socket.emit('player:update', JSON.stringify(coords));
    }

    function removePlayer(player) {
        var playerEl = document.getElementById("d-" + player.id);
        if (playerEl !== null) playerEl.remove();

        var feat = source.getFeatureById(player.id);
        if (feat !== null) {
            source.removeFeature(feat);
        }
    }

    function updatePlayer(player) {
        var playerEl = document.getElementById("d-" + player.id);
        if (playerEl === null) {
            var playerHTML = '<div>' +
                '<span class="player-data"></span>' +
                '<a href="javascript:void(0)"class="pull-right" onclick="disconnectPlayer(\'' + player.id + '\')">X</a>' +
                '</div>';

            playerHTML = '<div class="panel panel-default">' +
                '<div class="panel-body">' + playerHTML + '</div>' +
                '</div>';

            document.getElementById("connections").innerHTML +=
                '<div id="d-' + player.id + '">' + playerHTML + '</div>';
        }

        var playerEl = document.getElementById("d-" + player.id);
        var playerData = player.id + '<br/>' +
            '<div class="glyphicon glyphicon-map-marker" aria-hidden="true"> (' + player.x + ', ' + player.y + ')</div>';
        playerEl.getElementsByClassName("player-data")[0].innerHTML = playerData;

        var coords = [player.y, player.x];
        var feat = source.getFeatureById(player.id);
        if (feat === null) {
            feat = new ol.Feature({ name: player.id, geometry: new ol.geom.Point(coords, 'XY') });
            feat.setId(player.id);
            feat.setStyle(groupStyles.player);
            source.addFeature(feat);
        }

        feat.getGeometry().setCoordinates(coords);
    }

    function showCircle(id, center, distanceInMeters) {
        var id = "circle-" + id;
        var feat = source.getFeatureById(id);
        if (feat !== null && distanceInMeters >= 900) {
            source.removeFeature(feat);
        }

        var distance = (distanceInMeters / 100000);
        if (feat !== null) {
            feat.getGeometry().setCenterAndRadius(center, distance);
            return;
        }

        feat = new ol.Feature({ name: id, geometry: new ol.geom.Circle(center, distance, 'XY') })
        feat.setId(id);
        feat.setStyle(groupStyles.circle);
        source.addFeature(feat);
    }

    function toggleRun(btn) {
        if (this.interval !== undefined) {
            clearInterval(this.interval);
            this.interval = undefined;
            btn.innerText = btn.originalText;
            return;
        }
        btn.originalText = btn.innerText;
        btn.innerText = "stop";
        this.interval = setInterval(function () {
            EventHandler.player.y += 0.00005;
            EventHandler.player.x += 0.00005;
            socket.emit('player:update', JSON.stringify(EventHandler.player));
        }, 100);
    }

    function resetInterface() {
        document.getElementById("connections").innerHTML = "";
        source.clear(true);
    }

    function log(msg) {
        let logEl = document.getElementById("log");
        logEl.innerHTML = msg;
    }

    var groupStyles = {
        circle: new ol.style.Style({ stroke: new ol.style.Stroke({ color: 'rgba(239, 21, 9, 0.53)', width: 1 }) }),
        geofences: new ol.style.Style({
            stroke: new ol.style.Stroke({ color: 'black', width: 2 }),
            fill: new ol.style.Fill({ color: 'rgba(0, 0, 255, 0.1)' })
        }),
        checkpoint: new ol.style.Style({ image: new ol.style.Icon(({ anchor: [0.5, 0.9], src: 'checkpoint.png' })) }),
        player: new ol.style.Style({ image: new ol.style.Icon(({ anchor: [0.5, 0.9], src: 'marker.png' })) })
    }

    function bindDrawGroupButton(group, map, type) {
        var draw = new ol.interaction.Draw({ source: source, type: type, style: groupStyles[group] });
        draw.on("drawend", function (evt) {
            var g = evt.feature.getGeometry();
            var geojson = new ol.format.GeoJSON().writeGeometry(g);
            var name = prompt("What is this " + group + " name?");
            socket.emit('admin:feature:add', group, name, geojson);
            setTimeout(function () {
                map.removeInteraction(draw);
                source.removeFeature(evt.feature);
            });
        });
        document.getElementById("draw-" + group).addEventListener("click", function () {
            map.addInteraction(draw);
        });
        document.addEventListener("keydown", function (e) {
            if (e.key.toLowerCase() == "escape") {
                map.removeInteraction(draw);
            }
        });
    }


    var source = new ol.source.Vector({ wrapX: false });

    var socket = io('//' + location.host);
    var EventHandler = {
        player: { x: 0, y: 0 },

        onConnect: function (so) {
            log("connected");
            navigator.geolocation.getCurrentPosition(updatePosition)
        },
        onDisconnected: function () {
            log("disconnected");
            resetInterface();
            removePlayer(EventHandler.player);
        },
        onPlayerRegistred: function (player) {
            if (player.x == 0 && player.y == 0) recoverPosition();
            EventHandler.player = player;
            log("connected as \n" + player.id);
            requestFeatures();
        },
        onPlayerUpdated: function (player) {
            EventHandler.player = player;
            updatePlayer(player);
        },
        onRemotePlayerList: function (list) {
            resetInterface();
            for (let i in list.players) {
                updatePlayer(list.players[i]);
            }
        },
        onRemotePlayerUpdated: function (player) {
            updatePlayer(player);
        },
        onRemotePlayerNew: function (player) {
            updatePlayer(player)
        },
        onRemotePlayerDestroy: function (player) {
            removePlayer(player);
        },

        onFeatureAdded: function (jsonF) {
            var feat = new ol.format.GeoJSON().readFeature(jsonF.coords);
            source.addFeature(feat);

            if (groupStyles[jsonF.group] !== undefined) {
                feat.setStyle(groupStyles[jsonF.group]);
            }
            feat.setId(jsonF.id);
        },
        onFeatureList: function (features) {
            for (var i in features) {
                EventHandler.onFeatureAdded(features[i]);
            }
        },

        onFeatureCheckpoint: function (featID, checkPointID, lon, lat, distance) {
            console.log(checkPointID + "" + featID, [lon, lat], distance);
            showCircle(checkPointID + "" + featID, [lon, lat], distance);
        }
    };


    window.addEventListener("DOMContentLoaded", function () {
        socket.on('connect', EventHandler.onConnect);
        socket.on('player:registred', EventHandler.onPlayerRegistred)
        socket.on('player:updated', EventHandler.onPlayerUpdated)
        socket.on('disconnect', EventHandler.onDisconnected)

        socket.on('remote-player:list', EventHandler.onRemotePlayerList);
        socket.on('remote-player:updated', EventHandler.onRemotePlayerUpdated)
        socket.on('remote-player:new', EventHandler.onRemotePlayerNew);
        socket.on("remote-player:destroy", EventHandler.onRemotePlayerDestroy);

        socket.on("admin:feature:list", EventHandler.onFeatureList);
        socket.on("admin:feature:added", EventHandler.onFeatureAdded);

        socket.on("admin:feature:checkpoint", EventHandler.onFeatureCheckpoint)

        navigator.geolocation.watchPosition(updatePosition);

        var raster = new ol.layer.Tile({ source: new ol.source.OSM() });
        var vector = new ol.layer.Vector({ source: source });
        var view = new ol.View({ center: [-51.21766, -30.034647], zoom: 15, projection: "EPSG:4326" })
        var map = new ol.Map({ layers: [raster, vector], target: 'map', view: view });

        bindDrawGroupButton("geofences", map, "Polygon");
        bindDrawGroupButton("checkpoint", map, "Point");
    });

</script>

<body class="container-fluid">

    <head>
        <h1>CatchCatch</h1>
    </head>

    <div class="row">
        <div class="col-xs-4">
            <strong class="lead">Connections</strong>
            <button type="button" class="btn btn-link" onclick="toggleRun(this)">start</button>
            <button type="button" class="btn btn-link" onclick="reset()">reset</button>

            <pre id="log"></pre>
            <div id="connections"></div>
        </div>

        <div class="col-xs-8">
            <strong class="lead">Map</strong>
            <button id="draw-geofences" type="button" class="btn btn-link">draw fence</button>
            <button id="draw-checkpoint" type="button" class="btn btn-link">draw checkpoint</button>

            <div id="map" style="height: 70%"></div>
        </div>
    </div>
</body>