<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>

<script>
    var I = {
        player: {},

        showListAllPlayers: function(list) {
            console.log("player:list", list);
            var connectionsEl = document.getElementById("connections");
            connectionsEl.innerHTML = "";
            for (let i in list.players) {
                let player = list.players[i];
                connectionsEl.innerHTML += "<li id='d-" + player.id + "'>" + JSON.stringify(player) + "</li>";
            }
        },
        registerMyData: function(player) {
            this.player = player;
            let logEl = document.getElementById("log");
            logEl.innerHTML = "connected as " + this.player.id;
        },
        showSuccessMessage: function(player) {
            let logEl = document.getElementById("log");
            logEl.innerHTML = "connected as " + this.player.id + " - pos: (" + player.x + "," + player.y + ")";
        },
        showConnected: function() {
            console.log("connected");
        }
    };
    

  window.addEventListener("DOMContentLoaded", function() {
      var socket = io('//' + location.host);
      socket.on('connect', I.showConnected);
      socket.on('player:list', I.showListAllPlayers);
      socket.on('player:registred', I.registerMyData)
      socket.on('player:updated', I.showSuccessMessage)
      socket.on('disconnected', function() {
          console.log("disconnected");
      })
      
      socket.on('remote-player:updated', function(player) {
          var playerEl = document.getElementById("d-" + player.id);
          if (playerEl !== null) playerEl.innerText = JSON.stringify(player);
      })
  
      socket.on('remote-player:new', function(player) {
          var connectionsEl = document.getElementById("connections");
          connectionsEl.innerHTML += "<li id='d-" + player.id + "'>" + JSON.stringify(player) + "</li>";
      });
  
      socket.on("remote-player:destroy", function(player) {
          var playerEl = document.getElementById("d-" + player.id);
          if (playerEl !== null) playerEl.remove();
      });
  
      navigator.geolocation.watchPosition(function(pos) {
          console.log("position updated");
          var coords = {x: pos.coords.latitude, y: pos.coords.longitude};
          socket.emit('player:update', JSON.stringify(coords));
      });
  });
</script>

<body>
    <h1>Connections</h1>
    <h2 id="log"></h2>
    <ul id="connections"></ul>
</body>