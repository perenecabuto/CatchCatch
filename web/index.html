<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1, user-scalable=no">
<!-- Latest compiled and minified CSS -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css"
    integrity="sha384-BVYiiSIFeK1dGmJRAkycuHAHRg32OmUcww7on3RYdg4Va+PmSTsz/K68vbdEjh4u" crossorigin="anonymous">
<!-- Optional theme -->
<link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap-theme.min.css"
    integrity="sha384-rHyoN1iRsVXV4nD0JutlnGaslCJuC7uwjduW9SVrLvRYooPp2bWYgmgJQIXwl/Sp" crossorigin="anonymous">

<script src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/1.7.3/socket.io.min.js"></script>

<script>

    function removePlayer(playerId) {
        console.log("remove", playerId);
        socket.emit('admin:disconnect', playerId);
    }

    function renderPlayerItem(player) {
        var playerData = player.id + '(' + player.x + ',' + player.y + ')';
        var playerEl = document.getElementById("d-" + player.id);
        if (playerEl === null) {
            var playerHTML = '<span class="glyphicon glyphicon-map-marker" aria-hidden="true"></span>' +
                '<span class="player-data"></span>' +
                '<span class="pull-right" onclick="removePlayer(\''+ player.id +'\')">X</span>';

            playerHTML = '<div class="panel panel-default">' +
                '<div class="panel-body">' + playerHTML + '</div>' +
                '</div>';

            document.getElementById("connections").innerHTML +=
                '<div id="d-' + player.id + '">' + playerHTML + '</div>';
        }
        
        var playerEl = document.getElementById("d-" + player.id);
        playerEl.getElementsByClassName("player-data")[0].innerHTML = playerData;
    }

    var socket = io('//' + location.host);
    var EventHandler = {
        player: {},

        onRemotePlayerList: function (list) {
            console.log("remote-player:list", list);
            var connectionsEl = document.getElementById("connections");
            connectionsEl.innerHTML = "";
            for (let i in list.players) {
                renderPlayerItem(list.players[i]);
            }
        },
        onPlayerRegistred: function (player) {
            this.player = player;
            let logEl = document.getElementById("log");
            logEl.innerHTML = "connected as " + this.player.id;

            var that = this;
            setInterval(function() {
                if (!document.getElementById("run").checked) return;
                
                that.player.y += 0.00005
                that.player.x += 0.00005
                socket.emit('player:update', JSON.stringify(that.player));
            }, 100);
        },
        onPlayerUpdated: function (player) {
            let logEl = document.getElementById("log");
            this.player = player;
            renderPlayerItem(player);
        },
        onRemotePlayerUpdated: function (player) {
            renderPlayerItem(player);
        },
        onRemotePlayerNew: function (player) {
            renderPlayerItem(player)
        },
        onRemotePlayerDestroy: function (player) {
            console.log("player-destroy:", player);
            var playerEl = document.getElementById("d-" + player.id);
            if (playerEl !== null) playerEl.remove();
        },
        onConnect: function () {
            let logEl = document.getElementById("log");            
            logEl.innerHTML = "connected";
        },
        onDisconnected: function () {
            let logEl = document.getElementById("log");
            logEl.innerHTML = "disconnected";
        }
    };

    window.addEventListener("DOMContentLoaded", function () {
        socket.on('connect', EventHandler.onConnect);
        socket.on('player:registred', EventHandler.onPlayerRegistred)
        socket.on('player:updated', EventHandler.onPlayerUpdated)
        socket.on('disconnected', EventHandler.onDisconnected)

        socket.on('remote-player:list', EventHandler.onRemotePlayerList);
        socket.on('remote-player:updated', EventHandler.onRemotePlayerUpdated)
        socket.on('remote-player:new', EventHandler.onRemotePlayerNew);
        socket.on("remote-player:destroy", EventHandler.onRemotePlayerDestroy);

        navigator.geolocation.watchPosition(function (pos) {
            console.log("position updated");
            var coords = { x: pos.coords.latitude, y: pos.coords.longitude };
            socket.emit('player:update', JSON.stringify(coords));
        });
    });

</script>

<body>
    <div class="container-fluid">
        <div>
            <label for="run">Run</run>
            <input type="checkbox" id="run">
        </div>
        <h1>Connections</h1>
        <h2 id="log"></h2>
        <div id="connections"></div>
    </div>
</body>